# US007 - Parsing du sitemap Yoast pour le site nouveau

## 📋 Contexte
Suite à l'analyse que le nouveau site en préproduction est souvent bloqué par `robots.txt`, `noindex` ou authentification, nous avons adapté la stratégie de collecte des URLs pour utiliser le parsing du sitemap XML plutôt que le scraping.

## 🎯 Objectif
Permettre le parsing récursif des sitemaps Yoast (incluant les sitemaps index avec sous-sitemaps) pour extraire toutes les URLs du nouveau site en préproduction.

## ✅ Critères d'acceptation

- [x] Parser un sitemap XML standard
- [x] Détecter et parser récursivement les sitemaps index
- [x] Extraire les URLs des sous-sitemaps (post-sitemap.xml, page-sitemap.xml, category-sitemap.xml, etc.)
- [x] Éviter les boucles infinies lors du parsing récursif
- [x] Convertir les URLs absolues en URLs relatives pour le matching
- [x] Gérer les erreurs de connexion et de parsing gracieusement

## 🔧 Implémentation

### Fonction backend : `parse_sitemap()`

```python
def parse_sitemap(sitemap_url: str, recursive: bool = True, _visited: set = None) -> List[str]
```

**Paramètres :**
- `sitemap_url` : URL du sitemap à parser
- `recursive` : Si True, parse récursivement les sitemaps index
- `_visited` : Set interne pour éviter les boucles infinies

**Fonctionnalités :**
- Détection automatique des sous-sitemaps (patterns : sitemap*.xml, *-sitemap.xml, post-sitemap, page-sitemap, etc.)
- Parsing récursif avec protection contre les boucles
- Support des sitemaps Yoast SEO et standards
- User-Agent dédié : "301-Redirect-Bot (Sitemap Parser)"

### Intégration frontend

Dans l'interface Streamlit :
- Champ dédié pour l'URL du sitemap du nouveau site
- Suggestions d'URLs courantes (`/sitemap.xml`, `/sitemap_index.xml`, `/wp-sitemap.xml`)
- Bouton "📄 Parser le sitemap" distinct du scraping
- Affichage du nombre d'URLs trouvées avec aperçu

## 📊 Résultats de test

Test avec sitemap réel : `http://72.web.thelis.es:30178/les-cascades/sitemap_index.xml`

```
✅ Sitemap index détecté et parsé
  → post-sitemap.xml : 105 URLs
  → page-sitemap.xml : 442 URLs  
  → category-sitemap.xml : 4 URLs
Total : 549 URLs extraites
```

## 🚀 Statut
**✅ TERMINÉE** - Implémentée et testée avec succès

## 📝 Notes techniques
- Utilisation de BeautifulSoup avec parser lxml pour robustesse
- Conversion automatique des URLs absolues en relatives
- Gestion des timeouts (30 secondes par sitemap)
- Dédoublonnage automatique des URLs