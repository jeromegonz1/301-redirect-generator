# US011 - Détection Automatique des Langues

## 📋 Contexte
Les sites multilingues nécessitent une gestion spécifique des redirections pour éviter les correspondances incorrectes entre langues différentes (FR→EN, ES→DE, etc.).

## 🎯 User Story

**En tant que** responsable SEO multilingue,  
**je veux** que l'outil détecte automatiquement la langue des URLs,  
**afin que** le matching se fasse uniquement entre langues identiques (FR/FR, EN/EN...).

## ✅ Critères d'acceptation

### Détection automatique
- [ ] Reconnaissance des patterns linguistiques courants
- [ ] Support des formats : `/fr/`, `/en/`, `-fr.`, `.en/`, etc.
- [ ] Détection des sous-domaines : `fr.site.com`, `en.site.com`
- [ ] Langue par défaut configurable (FR par défaut)
- [ ] Gestion des URLs sans indication de langue

### Langues supportées
- [ ] Français (fr) - Priorité 1
- [ ] Anglais (en) - Priorité 1  
- [ ] Allemand (de) - Priorité 1
- [ ] Espagnol (es) - Priorité 2
- [ ] Italien (it) - Priorité 2
- [ ] Néerlandais (nl) - Priorité 2

### Affichage et groupement
- [ ] Répartition visuelle des URLs par langue
- [ ] Compteurs par langue (Ancien : FR 400, EN 200, etc.)
- [ ] Identification des langues déséquilibrées
- [ ] Alertes pour langues complètement absentes

## 🔍 Patterns de Détection

### Patterns supportés par langue
```python
LANGUAGE_PATTERNS = {
    'fr': [
        r'^/fr/',           # /fr/contact
        r'/(fr)$',          # /contact/fr
        r'-fr[./]',         # /contact-fr.html
        r'\.fr/',           # domain.fr/page
        r'fr\..*\.com'      # fr.site.com
    ],
    'en': [
        r'^/en/',           # /en/contact  
        r'/(en)$',          # /contact/en
        r'-en[./]',         # /contact-en.html
        r'\.co\.uk/',       # domain.co.uk/page
        r'en\..*\.com'      # en.site.com
    ],
    'de': [
        r'^/de/',           # /de/kontakt
        r'/(de)$',          # /kontakt/de
        r'-de[./]',         # /kontakt-de.html
        r'\.de/',           # domain.de/page
        r'de\..*\.com'      # de.site.com
    ]
}
```

### Exemples de détection
| URL | Langue détectée | Pattern utilisé |
|-----|----------------|-----------------|
| `/fr/camping-presentation` | FR | Préfixe `/fr/` |
| `/contact-en.html` | EN | Suffixe `-en` |
| `es.campinglescascades.com/servicios` | ES | Sous-domaine |
| `/contact` | FR | Défaut configuré |
| `/de/uber-uns` | DE | Préfixe `/de/` |

## 🏗️ Spécifications techniques

### Classe LanguageDetector
```python
class LanguageDetector:
    def __init__(self, default_language: str = 'fr'):
        self.default_language = default_language
        self.patterns = LANGUAGE_PATTERNS
    
    def detect(self, url: str) -> str:
        """Détecte la langue d'une URL"""
        
    def detect_bulk(self, urls: List[str]) -> Dict[str, str]:
        """Détecte les langues pour une liste d'URLs"""
        
    def group_by_language(self, urls: List[str]) -> Dict[str, List[str]]:
        """Groupe les URLs par langue détectée"""
        
    def get_language_stats(self, urls: List[str]) -> Dict[str, int]:
        """Statistiques de répartition par langue"""
```

### Algorithme de détection
```python
def detect_language(url: str) -> str:
    # 1. Test des patterns par ordre de priorité
    for lang, patterns in LANGUAGE_PATTERNS.items():
        for pattern in patterns:
            if re.search(pattern, url, re.IGNORECASE):
                return lang
    
    # 2. Fallback sur langue par défaut
    return self.default_language
```

## 🎨 Interface utilisateur

### Affichage de répartition
```
🌍 Détection automatique des langues

📊 Répartition ancien site (800 URLs) :
├── 🇫🇷 Français : 400 URLs (50%)
├── 🇬🇧 Anglais : 200 URLs (25%)  
├── 🇩🇪 Allemand : 100 URLs (12.5%)
├── 🇪🇸 Espagnol : 80 URLs (10%)
└── 🇮🇹 Italien : 20 URLs (2.5%)

📊 Répartition nouveau site (549 URLs) :
├── 🇫🇷 Français : 300 URLs (55%)
├── 🇬🇧 Anglais : 150 URLs (27%)
├── 🇩🇪 Allemand : 99 URLs (18%)
├── 🇪🇸 Espagnol : 0 URLs (0%) ⚠️
└── 🇮🇹 Italien : 0 URLs (0%) ⚠️
```

### Alertes de déséquilibre
- 🟡 **Attention** : Langue présente dans ancien mais pas nouveau (ES, IT)
- 🔴 **Critique** : Plus de 50% d'écart entre ancien/nouveau pour une langue
- ℹ️ **Info** : Suggestion de fallback 302 pour langues manquantes

## 🧪 Tests de détection

### Test 1: Patterns courants
```python
test_cases = [
    ("/fr/contact", "fr"),
    ("/en/about-us", "en"), 
    ("/de/uber-uns", "de"),
    ("/contact-es.html", "es"),
    ("fr.site.com/page", "fr"),
    ("/simple-page", "fr")  # défaut
]
```

### Test 2: URLs réelles
```python
real_urls = [
    "https://www.campinglescascades.com/fr/camping-presentation-gard",
    "http://72.web.thelis.es:30178/les-cascades/nl/contact",
    "/en/mobile-home-luxury",
    "/restaurant" # défaut FR
]
```

### Test 3: Performance
- [ ] Détection de 1000 URLs en < 1 seconde
- [ ] Mémoire : < 10MB pour 10k URLs
- [ ] Pas de regex catastrophique

## 📊 Métriques de qualité

### Précision de détection
- **Patterns explicites** : 99% de précision attendue
- **Fallback défaut** : Configurabilité selon le site
- **Faux positifs** : < 1% (ex: `/friend/` détecté comme FR)

### Couverture linguistique
- **Obligatoire** : FR, EN, DE (cas d'usage principal)
- **Optionnel** : ES, IT, NL (extension future)
- **Extensible** : Ajout facile de nouveaux patterns

## 🚫 Exclusions

- Détection du contenu textuel des pages (hors scope)
- Translation automatique entre langues
- Matching entre langues différentes (géré par US012)
- Gestion des fallbacks 302 (géré par US013)

## 🔄 Statut
**🔄 À développer** - Module de détection avec patterns regex

---

*US011 développée pour SEPTEO Digital Services*  
*Détection automatique des langues pour sites multilingues*